{"version":3,"file":"eventer.es.js","sources":["../src/eventer.ts"],"sourcesContent":["/**\r\n * Eventer error message, adds 'EventError:' prefix to error message\r\n */\r\nexport class EventError extends Error {\r\n    constructor(m: string) {\r\n        const errorMessage = `EventError: ${m}}`\r\n        super(errorMessage)\r\n        // Stupid workaround for a smooth support of ES5\r\n        Object.setPrototypeOf(this, EventError.prototype)\r\n    }\r\n}\r\n/**\r\n * Event Listener interface\r\n */\r\nexport type Listener<T = unknown> = (...args: unknown[]) => T\r\n/**\r\n * Subscription representation\r\n */\r\nexport interface Token {\r\n    /**\r\n     * Unique token ID\r\n     */\r\n    readonly token: string\r\n    /**\r\n     * ID of Eventer issued the token\r\n     */\r\n    readonly ownerIndex: number\r\n    /**\r\n     * Internal token ID, might be in collision with another Eventer instance\r\n     */\r\n    readonly id: number\r\n}\r\n/**\r\n * @param ownerIndex Index of Eventer\r\n * @param id         Index of current subscription\r\n * @return           Unique Token\r\n */\r\nexport const TokenFactory = (ownerIndex: number, id: number): Token => ({\r\n    token: `${ownerIndex}-${id}`,\r\n    ownerIndex,\r\n    id,\r\n})\r\n// Every eventer has to have unique id across an app\r\nlet lastId = 0\r\n/**\r\n * Creates Error for non-existing event listener.\r\n * The Error message is used in multiple occasions.\r\n * @param token Token of non-existing event\r\n * @param id    Eventer id\r\n */\r\nconst notExistReport = (token: Token, id: number) =>\r\n    new EventError(`Event listener with ${token.token} id does not exist at Eventer with ${id} id.`)\r\n/**\r\n * Pub/Sub for internal event scheduling.\r\n * All functions are for protected usage.\r\n * Sub class can use them for implementation of event dispatching.\r\n * @property  id  Unique Eventer id\r\n */\r\nexport class Eventer {\r\n    /**\r\n     * Unique id\r\n     */\r\n    /* eslint-disable-next-line no-plusplus */\r\n    readonly id = ++lastId\r\n\r\n    /**\r\n     * Index of last issued token\r\n     */\r\n    private lastEventIndex = 0\r\n\r\n    /**\r\n     * Collection of topics\r\n     */\r\n    private readonly topics: Map<string, Map<Token, Listener>> = new Map()\r\n\r\n    /**\r\n     *\r\n     */\r\n    constructor() {}\r\n\r\n    /**\r\n     * Register subscription on the topic with provided listener\r\n     * @param topic     Topic name\r\n     * @param listener  Event listener\r\n     * @param oldToken  Old token, if it has to be reused\r\n     */\r\n    on(topic: string, listener: Listener, oldToken?: Token): Token {\r\n        const listeners = this.topics.get(topic)\r\n        // use old token or create unique one\r\n        const token = oldToken || TokenFactory(this.id, (this.lastEventIndex += 1))\r\n        if (listeners)\r\n            // add listener to the topic\r\n            listeners.set(token, listener)\r\n        // create new topic with the listener\r\n        else this.topics.set(topic, new Map([[token, listener]]))\r\n        return token\r\n    }\r\n\r\n    /**\r\n     * Check if listener with provided token exists\r\n     * @param token Token of desired listener\r\n     * @param topic Topic which has to contain the listener\r\n     * @return      Error with message or Listener\r\n     */\r\n    has(token: Token, topic?: string): EventError | Listener {\r\n        // if topic is specified\r\n        if (topic) {\r\n            // request all listeners subscribed to the topic\r\n            const listeners = this.topics.get(topic)\r\n            if (listeners) {\r\n                // request listener with the token\r\n                const listener = listeners.get(token)\r\n                if (listener)\r\n                    // return the listener if it is defined\r\n                    return listener\r\n                // return error if it is not defined\r\n                return notExistReport(token, this.id)\r\n            }\r\n            // return error if topic is empty\r\n            return new EventError(`Eventer with ${token.ownerIndex} does not have ${topic}.`)\r\n        }\r\n        // iterate over all topics\r\n        for (const [_, listeners] of this.topics) {\r\n            // check if it has listener with desired token\r\n            const listener = listeners.get(token)\r\n            if (listener)\r\n                // return the listener\r\n                return listener\r\n        }\r\n        // return an error with none of topics contains listeners with desired token.\r\n        return notExistReport(token, this.id)\r\n    }\r\n\r\n    /**\r\n     * Remove listener with provided token\r\n     * @param token Token of the listener\r\n     * @param topic Topic which has to contain the listener\r\n     * @return      True if the listener is successfully removed and false if it is not found\r\n     */\r\n    off(token: Token, topic?: string) {\r\n        // if topic is specified\r\n        if (topic) {\r\n            // request all listeners subscribed to the topic\r\n            const listeners = this.topics.get(topic)\r\n            if (listeners)\r\n                if (listeners.delete(token))\r\n                    // check listener with the token existence\r\n                    return true\r\n            // return false with the topic does not contain listener with specified token\r\n            return false\r\n        }\r\n        // iterate over all topics\r\n        // check listener with the token existence\r\n        for (const [_, listeners] of this.topics) if (listeners.delete(token)) return true\r\n        // return false with all topics do not contain listener with specified token\r\n        return false\r\n    }\r\n\r\n    /**\r\n     * Remove all topics with all listeners\r\n     */\r\n    allOff() {\r\n        this.topics.clear()\r\n        return this\r\n    }\r\n\r\n    /**\r\n     * Remove topic with all listeners\r\n     * @param topic Topic name\r\n     * @return      True if the topic is successfully removed and false if it is not found\r\n     */\r\n    topicOff(topic: string) {\r\n        return this.topics.delete(topic)\r\n    }\r\n\r\n    /**\r\n     * Emit event and call subscribed listeners\r\n     * @param   topic Topic name\r\n     * @param   args  Array of arguments\r\n     * @return        Array that contains all return values from triggered event handlers in no particular order.\r\n     */\r\n    emit<T = unknown>(topic: string, ...args: Array<unknown>): T[] {\r\n        // request all listeners subscribed to the topic\r\n        const listeners = this.topics.get(topic)\r\n        if (listeners) {\r\n            // copy listeners to prevent concurrent modification in event handlers.\r\n            const listenersCopy = Array.from(listeners.values()) as Listener<T>[]\r\n            // call event handlers.\r\n            const returnValues = listenersCopy.map((listener) => listener(...args))\r\n            return returnValues\r\n        }\r\n        return []\r\n    }\r\n\r\n    /**\r\n     * Get All listeners at the topic\r\n     * @param topic Topic name\r\n     */\r\n    listeners(topic: string) {\r\n        const listeners = this.topics.get(topic)\r\n        if (listeners) return listeners\r\n        return new Map<Token, Listener>()\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}